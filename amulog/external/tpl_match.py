#!/usr/bin/env python
# coding: utf-8

"""Matching raw log messages and its templates
that is generated by external tools."""

import re
from collections import defaultdict

REPLACER = re.compile(r"\\\*[A-Z]*?\\\*") # shortest match


def generate_regex(tpl):
    d_name = defaultdict(list)

    def replace_wildcard(matchobj):
        name = matchobj.group(0).strip("\\*")
        v = len(d_name[name])
        vname = name + str(v)
        d_name[name].append(vname)
        regexstr = r"(?P<" + vname + r">[^*]*)" # shortest match
        return regexstr

    regex_base = r"^" + re.escape(tpl) + r"$"
    tmp = REPLACER.sub(replace_wildcard, regex_base, count = 0)
    return re.compile(tmp)


def match_line(parsed_line, l_regex):
    for rid, regex in enumerate(l_regex):
        m = regex.match(parsed_line["message"])
        if m:
            return rid, m
    else:
        return None

